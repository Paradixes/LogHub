@using Client.Features.Components.Components
@inject ILogHubAuthenticationService AuthenticationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject HttpClient Client

<AuthorizeView>
    <Authorized>
        <MudDrawer @bind-Open="DrawerOpen" Elevation="1" Width="300px">
            <MudDrawerHeader>
                <MudMenu AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" FullWidth="true" Style="width: 100%">
                    <ActivatorContent>
                        <MudButton Color="Color.Surface" Style="width: 100%">
                            <MudAvatar Color="Color.Tertiary" Size="Size.Medium">
                                @if (UserAccountModel?.AvatarUri is not null)
                                {
                                    <MudImage Src="@UserAccountModel.AvatarUri.ToString()"/>
                                }
                                else if (UserAccountModel?.Name.Length > 0)
                                {
                                    @UserAccountModel?.Name?[0]
                                }
                            </MudAvatar>
                            <MudText Typo="Typo.h6" Class="pl-2">
                                @UserAccountModel?.Name
                            </MudText>
                            <MudSpacer/>
                        </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem Href="/profile">
                            Profile
                        </MudMenuItem>
                        <MudMenuItem Href="/settings">
                            Settings
                        </MudMenuItem>
                        <MudMenuItem OnClick="LogOutAsync">
                            Sign out
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </MudDrawerHeader>
            <MudNavMenu Bordered="true">
                <MudNavLink Href="search" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Search">Search</MudNavLink>
                <MudNavGroup Title="Settings" Icon="@Icons.Material.Filled.Settings">
                    <MudNavLink Href="users/account" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountCircle">
                        Account
                    </MudNavLink>
                    <MudNavLink Href="users/system" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SettingsInputComponent">
                        System
                    </MudNavLink>
                </MudNavGroup>
                <OrganisationNavMenu/>
                <ProjectNavMenu/>
            </MudNavMenu>
        </MudDrawer>
    </Authorized>
</AuthorizeView>

@code {

    private UserAccountModel? UserAccountModel { get; set; } = new();

    [Parameter]
    public bool DrawerOpen { get; set; }


    private void DrawerToggle(bool isDrawerOpen)
    {
        DrawerOpen = isDrawerOpen;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var userId = await AuthenticationService.GetUserIdAsync();
        if (userId == Guid.Empty)
        {
            return;
        }
        UserAccountModel = await Client.GetFromJsonAsync<UserAccountModel>($"api/users/{userId}");
    }

    private async Task LogOutAsync()
    {
        await AuthenticationService.LogOutAsync();
        NavigationManager.NavigateTo("/");
        DrawerOpen = false;
    }

}
